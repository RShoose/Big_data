
# Администрирование HDFS: теория и практика

## 📋 План вебинара <a id="план-вебинара"></a>
### **1. [Архитектура и базовый мониторинг HDFS](#1)**
- Архитектура HDFS в схемах
- Ключевые концепции и инструменты мониторинга
- Практика: проверка состояния и топологии кластера

### **2. [Конфигурационные файлы HDFS](#2)**
- Архитектура конфигурации HDFS
- Детальные параметры конфигурации
- Практика: анализ и управление конфигурацией

### **3. [Диагностика и мониторинг HDFS](#3)**
- Инструменты диагностики HDFS
- Детальная работа с hdfs fsck
- Практика: комплексная диагностика и поиск проблем

### **4. [Управление ресурсами: квоты HDFS](#4)**
- Система квот HDFS
- Принципы работы и стратегии применения
- Практика: работа с space и namespace квотами

### **5. [Балансировка кластера HDFS](#5)**
- Принципы балансировки HDFS
- Механизм работы балансировщика
- Практика: создание дисбаланса и балансировка

### **6. [Q&A и резюме вебинара](#6)**
- Ключевые темы вебинара
- Типичные проблемы и решения
- Практика: финальная проверка и чеклист

---

<a name="1"></a>
## 1. Архитектура и базовый мониторинг HDFS

### **Теоретическая часть**

### **1.1. Архитектура HDFS в схемах**

#### **Компоненты кластера HDFS**
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   NameNode      │    │   DataNode      │    │   DataNode      │
│   (Master)      │    │   (Slave)       │    │   (Slave)       │
├─────────────────┤    ├─────────────────┤    ├─────────────────┤
│ • Метаданные    │◄---│ • Блоки данных  │    │ • Блоки данных  │
│ • FsImage       │    │ • Block reports │    │ • Block reports │
│ • EditLog       │    │ • Heartbeats    │    │ • Heartbeats    │
│ • BlockMap      │---►│ • Чтение/запись │    │ • Чтение/запись │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                        │                        │
         └────────────────────────┼────────────────────────┘
                                  ▼
                         ┌─────────────────┐
                         │    Клиенты      │
                         │  (Чтение/запись)│
                         └─────────────────┘
```

#### **Таблица компонентов HDFS**
| **Компонент** | **Роль** | **Хранит** | **Процессы** | **Порт** |
|---------------|----------|------------|--------------|----------|
| **NameNode** | Мастер-узел | Метаданные, FsImage, EditLog | Управление namespace, репликация | 9870 (Web) |
| **DataNode** | Slave-узел | Блоки данных, checksums | Чтение/запись, heartbeat | 9866 (Data) |
| **Secondary NN** | Помощник | Checkpoint'ы | Merge FsImage+EditLog | 9868 |
| **JournalNode** | HA-поддержка | Shared EditLog | Синхронизация | 8485 |

### **1.2. Ключевые концепции**

#### **Схема репликации с Rack Awareness**
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Rack 1    │    │   Rack 2    │    │   Rack 3    │
├─────────────┤    ├─────────────┤    ├─────────────┤
│ • DataNode1 │    │ • DataNode3 │    │ • DataNode5 │
│   REPLICA 1 │    │   REPLICA 3 │    │   REPLICA 2 │
│ • DataNode2 │    │ • DataNode4 │    │ • DataNode6 │
└─────────────┘    └─────────────┘    └─────────────┘
```

#### **Таблица стратегии репликации**
| **Реплика** | **Размещение** | **Цель** | **Условия** |
|-------------|----------------|----------|-------------|
| **1-я** | Локальный узел/стойка | Минимизация сетевого трафика | Если клиент в кластере |
| **2-я** | Другая стойка | Отказоустойчивость | Разные стойки для баланса |
| **3-я** | Третья стойка | Высокая доступность | Географическое распределение |

### **1.3. Инструменты мониторинга**

#### **Таблица команд мониторинга**
| **Команда** | **Назначение** | **Ключевые метрики** | **Частота использования** |
|-------------|----------------|---------------------|--------------------------|
| **`hdfs dfsadmin -report`** | Общий отчет кластера | Live/Dead nodes, Capacity, Used% | Ежедневно |
| **`hdfs dfsadmin -printTopology`** | Топология сети | Rack layout, Node distribution | При изменении топологии |
| **`hdfs fsck /`** | Проверка целостности | Corrupt blocks, Under-replicated | Еженедельно/при проблемах |
| **`hdfs dfs -df -h`** | Использование пространства | Used/Remaining space | Постоянно |
| **`jps`** | Проверка процессов | Running Java processes | При перезапуске сервисов |

#### **Схема Web UI NameNode (:9870)**
```
┌─────────────────────────────────────────────────┐
│                NameNode Web UI                  │
├─────────────────┬───────────────────────────────┤
│   Cluster       │  • Configured Capacity: 500GB │
│   Overview      │  • DFS Used: 150GB (30%)      │
│                 │  • Live Nodes: 3/3            │
├─────────────────┼───────────────────────────────┤
│   DataNodes     │ ┌─────┬────────┬────────────┐ │
│   Information   │ │ Node│ Used%  │Last Contact│ │
│                 │ ├─────┼────────┼────────────┤ │
│                 │ │ DN1 │ 28%    │ 10s ago    │ │
├─────────────────┼───────────────────────────────┤
│   Snapshots     │  • Last fsck: 2024-01-15      │
│   & Utilities   │  • Safe Mode: OFF             │
└─────────────────┴───────────────────────────────┘
```

### **1.4. Критические метрики**

#### **Таблица ключевых метрик**
| **Категория** | **Метрика** | **Нормальное значение** | **Тревожное значение** |
|---------------|-------------|------------------------|------------------------|
| **Доступность** | Live Nodes | = общему количеству DN | < общего количества DN |
| **Емкость** | DFS Used% | < 80% | > 85% |
| **Целостность** | Under Replicated Blocks | 0 | > 0 |
| **Целостность** | Corrupt Blocks | 0 | > 0 |
| **Производительность** | Pending Replication Blocks | < 100 | > 1000 |

### **1.5. Процессы работы HDFS**

#### **Схема чтения данных**
```
Клиент → NameNode (get block locations) → DataNodes (read data directly)
    1. Запрос метаданных
    2. Получение списка DataNodes
    3. Прямое чтение с DataNodes
    4. Failover при ошибках
```

#### **Схема записи данных**
```
Клиент → NameNode (create file) → DataNodes (pipeline write) → Подтверждение
    1. Создание файла в метаданных
    2. Получение конвейера DataNodes
    3. Поточная запись с репликацией
    4. Подтверждение операции
```

### **Практическая часть**

```bash
# Проверка состояния процессов
echo "=== Проверка процессов на NameNode ==="
jps | grep -E "NameNode|SecondaryNameNode"

# Базовый мониторинг кластера
echo "=== Общий отчет кластера ==="
hdfs dfsadmin -report

# Анализ топологии
echo "=== Топология кластера ==="
hdfs dfsadmin -printTopology

# Работа с Web UI
echo "Web UI доступен по: http://$(hostname -I | awk '{print $1}'):9870"
```

[🔼 Наверх](#план-вебинара)

---

<a name="2"></a>
## 2. Конфигурационные файлы HDFS

### **Теоретическая часть**

### **2.1. Архитектура конфигурации HDFS**

#### **Схема иерархии конфигурационных файлов**
```
┌─────────────────────────────────────────────────┐
│            Hadoop Configuration                 │
├─────────────────┬───────────────────────────────┤
│   core-site.xml │   hdfs-site.xml               │
│   • Общие       │   • Специфичные HDFS          │
│   настройки     │   настройки                   │
├─────────────────┼───────────────────────────────┤
│   workers       │   hadoop-env.sh               │
│   • Список      │   • Переменные окружения      │
│   DataNodes     │   • Параметры JVM             │
└─────────────────┴───────────────────────────────┘
```

#### **Таблица конфигурационных файлов**
| **Файл** | **Назначение** | **Ключевые параметры** | **Расположение** |
|----------|----------------|------------------------|------------------|
| **core-site.xml** | Общие настройки кластера | `fs.defaultFS`, `hadoop.tmp.dir` | `/etc/hadoop/conf/` |
| **hdfs-site.xml** | Специфичные настройки HDFS | `dfs.replication`, `dfs.blocksize` | `/etc/hadoop/conf/` |
| **workers** | Список DataNodes | hostnames DataNodes | `/etc/hadoop/conf/` |
| **hadoop-env.sh** | Переменные окружения | `JAVA_HOME`, `HADOOP_HEAPSIZE` | `/etc/hadoop/conf/` |

### **2.2. Детальные параметры конфигурации**

#### **core-site.xml - Критические параметры**
```xml
<property>
  <name>fs.defaultFS</name>
  <value>hdfs://namenode:9820</value>
</property>
<property>
  <name>hadoop.tmp.dir</name>
  <value>/opt/hadoop/tmp</value>
</property>
```

#### **hdfs-site.xml - Параметры NameNode**
```xml
<property>
  <name>dfs.namenode.name.dir</name>
  <value>file:///opt/hadoop/dfs/name</value>
</property>
<property>
  <name>dfs.permissions.enabled</name>
  <value>true</value>
</property>
```

### **Практическая часть**

```bash
# Анализ текущей конфигурации
cd /etc/hadoop/conf
ls -la *.xml workers

# Работа с core-site.xml
hdfs getconf -confKey fs.defaultFS

# Работа с hdfs-site.xml
hdfs getconf -confKey dfs.replication
hdfs getconf -confKey dfs.blocksize

# Анализ файла workers
cat workers
```

[🔼 Наверх](#план-вебинара)

---

<a name="3"></a>
## 3. Диагностика и мониторинг HDFS

### **Теоретическая часть**

### **3.1. Инструменты диагностики HDFS**

#### **Схема диагностического workflow**
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Быстрая       │    │   Детальная     │    │   Визуальный    │
│   проверка      │    │   диагностика   │    │   мониторинг    │
├─────────────────┤    ├─────────────────┤    ├─────────────────┤
│ • dfsadmin      │ →  │ • fsck          │ →  │ • Web UI        │
│   -report       │    │   -files        │    │   :9870         │
│ • dfs -df -h    │    │   -blocks       │    │ • JMX метрики   │
└─────────────────┘    │   -locations    │    └─────────────────┘
                       └─────────────────┘
```

#### **Таблица инструментов диагностики**
| **Инструмент** | **Назначение** | **Ключевые метрики** | **Когда использовать** |
|----------------|----------------|---------------------|------------------------|
| **`hdfs fsck`** | Проверка целостности данных | Corrupt blocks, Under-replicated | При проблемах с данными |
| **`hdfs dfsadmin`** | Мониторинг состояния | Live nodes, Capacity | Ежедневный мониторинг |
| **Web UI** | Визуальный анализ | Graphs, Node details | Постоянный мониторинг |
| **JMX интерфейс** | Метрики производительности | RPC stats, Memory | Глубокий анализ |

### **Практическая часть**

```bash
# Комплексная проверка файловой системы
hdfs fsck / -files -blocks -locations

# Поиск проблемных блоков
hdfs fsck / -list-corruptfileblocks

# Создание диагностического отчета
hdfs fsck / -files -blocks 2>/dev/null | grep -E "files|blocks|Healthy|Missing|Corrupt"

# Мониторинг через Web UI
curl -s "http://localhost:9870/jmx?qry=Hadoop:service=NameNode,name=NameNodeInfo"
```

[🔼 Наверх](#план-вебинара)

---

<a name="4"></a>
## 4. Управление ресурсами: квоты HDFS

### **Теоретическая часть**

### **4.1. Система квот HDFS**

#### **Схема работы квот**
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Space Quota   │    │  Namespace      │    │   Storage       │
│   (Байты)       │    │  Quota          │    │   Type Quota    │
├─────────────────┤    ├─────────────────┤    ├─────────────────┤
│ • Ограничение   │    │ • Ограничение   │    │ • Ограничение   │
│   дискового     │    │   количества    │    │   по типам      │
│   пространства  │    │   файлов и      │    │   хранения      │
│ • Жесткое       │    │   директорий    │    │ • SSD, DISK,    │
│   ограничение   │    │ • Жесткое       │    │   ARCHIVE       │
└─────────────────┘    │   ограничение   │    └─────────────────┘
                       └─────────────────┘
```

#### **Таблица типов квот**
| **Тип квоты** | **Единица измерения** | **Что ограничивает** | **Команда установки** |
|---------------|----------------------|---------------------|----------------------|
| **Space Quota** | Байты | Дисковое пространство | `hdfs dfsadmin -setSpaceQuota` |
| **Namespace Quota** | Количество объектов | Файлы и директории | `hdfs dfsadmin -setQuota` |
| **Storage Type Quota** | Байты по типам | Пространство по типам хранения | `hdfs dfs -setSpaceQuota` |

### **Практическая часть**

```bash
# Работа с Space Quotas
hdfs dfsadmin -setSpaceQuota 50M /test_quota
hdfs dfs -count -q /test_quota

# Работа с Namespace Quotas
hdfs dfsadmin -setQuota 5 /test_namespace
hdfs dfs -count -q /test_namespace

# Мониторинг квот
hdfs dfs -count -q /user/*

# Управление квотами
hdfs dfsadmin -clrSpaceQuota /test_quota
hdfs dfsadmin -clrQuota /test_namespace
```

[🔼 Наверх](#план-вебинара)

---

<a name="5"></a>
## 5. Балансировка кластера HDFS

### **Теоретическая часть**

### **5.1. Принципы балансировки HDFS**

#### **Схема дисбаланса и балансировки**
```
ДО балансировки:
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│  DataNode1  │  │  DataNode2  │  │  DataNode3  │
│   75% used  │  │   45% used  │  │   30% used  │
│   ███████   │  │   ████      │  │   ███       │
└─────────────┘  └─────────────┘  └─────────────┘

ПОСЛЕ балансировки:
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│  DataNode1  │  │  DataNode2  │  │  DataNode3  │
│   50% used  │  │   50% used  │  │   50% used  │
│   █████     │  │   █████     │  │   █████     │
└─────────────┘  └─────────────┘  └─────────────┘
```

#### **Таблица параметров балансировки**
| **Параметр** | **Значение по умолчанию** | **Описание** | **Рекомендации** |
|--------------|--------------------------|--------------|------------------|
| **threshold** | 10% | Максимальное отклонение от среднего | 5-15% в зависимости от нагрузки |
| **bandwidthPerSec** | 10 МБ/с | Скорость передачи | 50-100 МБ/с для быстрой балансировки |
| **exclude** | - | Исключаемые узлы | Узлы в maintenance |
| **include** | - | Включаемые узлы | Только определенные узлы |

### **Практическая часть**

```bash
# Анализ текущего распределения данных
hdfs dfsadmin -report | grep -E "Configured Capacity|Present Capacity|DFS Used%"

# Проверка необходимости балансировки
hdfs balancer -threshold 5

# Запуск балансировки
hdfs balancer -D dfs.datanode.balance.bandwidthPerSec=52428800 -threshold 10

# Мониторинг прогресса
hdfs dfsadmin -report | grep -A 3 "Datanode" | grep -E "Name|DFS Used%"
```

[🔼 Наверх](#план-вебинара)

---

<a name="6"></a>
## 6. Q&A и резюме вебинара

### **Теоретическая часть**

### **6.1. Ключевые темы вебинара**

#### **Схема администрирования HDFS**
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Мониторинг    │    │  Конфигурация   │    │  Управление     │
│   и диагностика │    │   и настройки   │    │   ресурсами     │
├─────────────────┤    ├─────────────────┤    ├─────────────────┤
│ • dfsadmin      │    │ • core-site.xml │    │ • Space Quotas  │
│ • fsck          │    │ • hdfs-site.xml │    │ • Namespace     │
│ • Web UI        │    │ • workers       │    │   Quotas        │
│ • jps           │    │ • getconf       │    │ • Балансировка  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

#### **Таблица освоенных навыков**
| **Навык** | **Команды** | **Назначение** | **Частота использования** |
|-----------|-------------|----------------|--------------------------|
| **Мониторинг** | `dfsadmin -report`, `fsck` | Контроль состояния кластера | Ежедневно |
| **Конфигурация** | `getconf`, редактирование XML | Настройка параметров | При изменениях |
| **Управление квотами** | `setSpaceQuota`, `setQuota` | Контроль ресурсов | По необходимости |
| **Балансировка** | `balancer` | Выравнивание нагрузки | После изменений кластера |

### **6.2. Типичные проблемы и решения**

#### **Таблица распространенных проблем**
| **Проблема** | **Симптомы** | **Диагностика** | **Решение** |
|-------------|--------------|-----------------|-------------|
| **Недостаток места** | Ошибки записи | `dfsadmin -report` | Очистка данных, квоты |
| **Потеря узлов** | Dead Nodes | `dfsadmin -report` | Перезапуск сервисов |
| **Поврежденные блоки** | Corrupt blocks | `fsck -list-corruptfileblocks` | Восстановление из реплик |
| **Дисбаланс** | Разное использование узлов | `dfsadmin -report` | Запуск балансировщика |

### **Практическая часть**

```bash
# Комплексная проверка кластера
hdfs dfsadmin -report | head -20
hdfs dfs -df -h
hdfs fsck / -files -blocks 2>/dev/null | grep -E "files|blocks|Healthy|Missing|Corrupt"

# Создание шпаргалки администратора
cat > /tmp/hdfs_cheatsheet.sh << 'EOF'
echo "HDFS Admin Cheat Sheet"
echo "1. Быстрая проверка: hdfs dfsadmin -report | grep -E 'Live|DFS Used%'"
echo "2. Проверка места: hdfs dfs -df -h"
echo "3. Поиск проблем: hdfs fsck / -list-corruptfileblocks"
echo "4. Балансировка: hdfs balancer -threshold 10"
EOF
```

[🔼 Наверх](#план-вебинара)

---

## Итоги вебинара

### **Освоенные навыки:**
- Мониторинг состояния кластера HDFS
- Работа с конфигурационными файлами
- Диагностика и устранение проблем
- Управление квотами и ресурсами
- Балансировка кластера

### **Ключевые команды:**
```bash
hdfs dfsadmin -report          # Общий мониторинг
hdfs fsck / -files -blocks     # Диагностика целостности
hdfs dfsadmin -setSpaceQuota   # Установка квот
hdfs balancer -threshold 10    # Балансировка кластера
```



