## **Вебинар 7: Сложные паттерны MapReduce в ритейл-аналитике**

### **Теоретическая часть** 

---

## **1. Вторичная сортировка (Secondary Sort) в ритейле** 

### **Проблема: Анализ временных рядов**
```python
# Без вторичной сортировки - данные вразброс
("2023-01", "Books")    → 4500
("2023-02", "Electronics") → 12000  
("2023-01", "Electronics") → 15000
("2023-02", "Books")    → 5200
```

### **Решение: Составной ключ с группировкой**
```python
# С вторичной сортировкой - упорядоченные данные
("2023-01", "Books")       → 4500
("2023-01", "Clothing")    → 8900
("2023-01", "Electronics") → 15000
("2023-02", "Books")       → 5200
("2023-02", "Clothing")    → 10200
("2023-02", "Electronics") → 12000
```

### **Архитектура Secondary Sort**
```
📊 Данные → 🗺️ Mapper → 🔄 Partitioner → 📂 Group Comparator → ♻️ Reducer
    ↓           ↓              ↓                 ↓                 ↓
   Raw        (K, V)      По году-месяцу    По категории      Агрегация
```

### **Визуализация: Продажи по месяцам и категориям**
```
 Выручка (тыс.$)
    │
20  │    ████████████████
    │    ████████████████ Electronics
15  │    ██████████      ██████████
    │    ██████████      ██████████ Clothing  
10  │    ████            ██████    ██████
    │    ████            ██████    ██████ Books
5   │    ██              ██        ██
    └─────────────────────────────────────
       Янв    Фев    Мар    Апр    Май
```

---

## **2. Составные ключи для многомерного анализа** 

### **Проблема: Множественные срезы данных**
Традиционный подход требует нескольких проходов:
1. 🗺️ Анализ по полу
2. 🗺️ Анализ по категориям  
3. 🗺️ Анализ по возрастным группам
4. 🗺️ Анализ по регионам

### **Решение: Единый проход с составными ключами**
```python
# Многомерная агрегация в одном Job
("Gender-Male", "Revenue")        → 150000
("Gender-Female", "Revenue")      → 120000
("Category-Electronics", "Revenue") → 90000
("Age-25-34", "Revenue")          → 80000
("Gender-Category-Male-Electronics", "Revenue") → 45000
```

### **Матрица потребительского поведения**
```
         Electronics  Clothing  Books  Home
Male       45,000     35,000   15,000 25,000
Female     30,000     55,000   20,000 15,000

        18-24      25-34      35-44      45+
Male   20,000     45,000     35,000   20,000  
Female 25,000     40,000     35,000   20,000
```

### **Визуализация: Гендерное распределение по категориям**
```
 Распределение покупок по полу и категориям
100% │
     │    ██████████████    ██████████████
     │    ██████████████    ██████████████
 75% │    ██████████████    ██████░░░░░░░░
     │    ██████████████    ██████░░░░░░░░ Female
 50% │    ██████░░░░░░░░    ██████░░░░░░░░
     │    ██████░░░░░░░░    ██████░░░░░░░░ Male
 25% │    ██████░░░░░░░░    ██████░░░░░░░░
     │    ██████░░░░░░░░    ██████░░░░░░░░
  0% └─────────────────────────────────────
      Electronics   Clothing   Books    Home
```

---

## **3. Multiple Outputs - единый проход для всей аналитики** 

### **Архитектура комплексного анализа**
```
📈 Входные данные
    ↓
🔄 Единый Mapper
    ↓  
📊 Multiple Outputs
    ├── 🗓️  Продажи по месяцам
    ├── 👥  Анализ по полу
    ├── 📦  Анализ по категориям
    ├── 🎯  Составные метрики
    └── 📈  Общая статистика
```

### **Ключевые метрики ритейл-аналитики**
```python
# В одном Mapper-е собираем все метрики
METRICS = {
    "Временные ряды": ["MONTHLY", "WEEKLY", "DAILY"],
    "Продуктовые": ["CATEGORY", "SUBCATEGORY", "BRAND"], 
    "Клиентские": ["GENDER", "AGE_GROUP", "REGION"],
    "Транзакционные": ["AVG_RECEIPT", "BASKET_SIZE", "FREQUENCY"],
    "Составные": ["GENDER_CATEGORY", "AGE_REGION", "SEASONALITY"]
}
```

### **Визуализация: Комплексная дашборд-аналитика**
```
RETAIL ANALYTICS DASHBOARD
┌─────────────────┬─────────────────┬─────────────────┐
│ВРЕМЕННЫЕ РЯДЫ   │    КЛИЕНТЫ      │   ПРОДУКТЫ      │
├─────────────────┼─────────────────┼─────────────────┤
│  150K ↗︎ 15%     │   Male: 55%     │  Electronics    │
│  125K ████████  │   Female: 45%   │  Clothing ████  │
│  100K ██████    │                 │  Books    ██    │
│   75K ████      │   25-34: 40%    │  Home     ██    │
│   50K ██        │   35-44: 30%    │                 │
│   25K █         │   18-24: 20%    │  Avg Receipt:   │
│    0K           │   45+: 10%      │    $85.20 ↗︎     │
│   J F M A M J   │                 │                 │
└─────────────────┴─────────────────┴─────────────────┘
```

---

## **4. Бизнес-кейсы применения** (10 мин)

### **Кейс 1: Сезонность продаж**
```
🎄 СЕЗОННОСТЬ ПРОДАЖ ПО КАТЕГОРИЯМ
    │
200%│              ██████████
    │              ██████████ Electronics 
150%│    ██████    ██    ██  ██████
    │    ██████    ██    ██  ██████ Clothing
100%│    ██  ██    ██    ██  ██  ██
    │    ██  ██    ██    ██  ██  ██ Books
 50%│  ██    ██████    ██    ██    ██
    │  ██    ██████    ██    ██    ██
    └────────────────────────────────────
       Q1   Q2   Q3   Q4   Holidays
```

### **Кейс 2: Сегментация покупателей**
```
СЕГМЕНТАЦИЯ ПОКУПАТЕЛЕЙ
High-Value    ██████████ 18%  | $500+ avg
Medium-Value  ██████████████ 25%  | $200-500  
Low-Value     ██████████████████ 35% | $50-200
Occasional    ███████████ 22%  | <$50

ВОЗРАСТНЫЕ СЕГМЕНТЫ
18-24: ██████ 20%   | Tech-savvy, impulse buys
25-34: ████████████ 35%   | Family needs, value
35-44: ██████████ 28%   | Quality focused  
45+:   █████ 17%   | Brand loyal, traditional
```

### **Кейс 3: Эффективность маркетинга**
```
ROI ПО КАНАЛАМ ПРОДАЖ
Online   ██████████████ 45%  | $2.10 ROI
Mobile   ██████████ 32%  | $1.80 ROI
Store    ██████ 23%  | $1.20 ROI

 ЦЕЛЕВЫЕ АУДИТОРИИ
Electronics: Male 25-34 ██████████
Clothing: Female 18-29 ████████████  
Books: Mixed 25-45 ████████
Home: Female 35-55 ██████
```

---

## **5. Техническая архитектура** (5 мин)

### **Оптимизация производительности**
```
⚡ ПАТТЕРНЫ ОПТИМИЗАЦИИ

Комбайнеры:    Локальная агрегация на mapper-узлах
Партиционирование: Равномерное распределение нагрузки  
In-Mapper Combiner: Уменьшение network I/O
Multiple Outputs: Избежание повторных проходов

МЕТРИКИ ЭФФЕКТИВНОСТИ

Data Locality:    95%  ✅
Network Transfer: 2.1GB  ✅  
Execution Time:   3.2min ✅
Resource Usage:   78%   ✅
```


